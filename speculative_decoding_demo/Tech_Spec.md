# æŠ€æœ¯è§„æ ¼ä¸å®šé‡ä»·å€¼åˆ†ææŠ¥å‘Šï¼šLLM æŠ•æœºè§£ç  (Speculative Decoding)

## 1. Terminology Adjustment Strategy (æœ¯è¯­é€‚é…ç­–ç•¥)

åŸºäº **"ç›´è§‰å‹åº”ç”¨å¼€å‘è€…"** çš„ç”»åƒï¼Œæˆ‘ä»¬å°†é‡‡ç”¨ **"èŒåœºéšå–» (Workplace Metaphor)"** æ¥è§£é‡Šæ ¸å¿ƒæ¦‚å¿µï¼Œç€é‡å¼ºè°ƒ**æˆæœ¬ä¸æ”¶ç›Š**ï¼ŒåŒæ—¶åœ¨å·¥ç¨‹ç»†èŠ‚ä¸Šä½¿ç”¨æ›´ä¸¥è°¨çš„æè¿°ä»¥çº æ­£ä¹‹å‰çš„è®¤çŸ¥åå·®ã€‚

| æ ¸å¿ƒæœ¯è¯­ (Technical Term) | é€‚é…æœ¯è¯­/éšå–» (Adaptive Metaphor) | å®šä¹‰ä¸è§£é‡Šç­–ç•¥ |
| :--- | :--- | :--- |
| **Draft Model** | **å®ä¹ ç”Ÿ (The Intern)** | **ç‰¹ç‚¹**: åŠ¨ä½œå¿«ã€è–ªæ°´ä½ (ç®—åŠ›æ¶ˆè€—å°)ï¼Œä½†ç»éªŒä¸è¶³ï¼Œå®¹æ˜“çŠ¯é”™ã€‚è´Ÿè´£å¿«é€Ÿèµ·è‰æ–‡æ¡ˆã€‚ |
| **Target Model** | **èµ„æ·±ä¸»ç¼– (The Editor-in-Chief)** | **ç‰¹ç‚¹**: æƒå¨ã€è–ªæ°´æé«˜ (ç®—åŠ›/å¸¦å®½æ˜‚è´µ)ï¼ŒåŠ¨ä½œç¨³å¥ã€‚è´Ÿè´£å¹¶è¡Œå®¡é˜…å®ä¹ ç”Ÿçš„è‰ç¨¿ã€‚ |
| **Speculative Window ($K$)** | **è‰ç¨¿æ‰¹æ¬¡ (Draft Batch)** | å®ä¹ ç”Ÿä¸€æ¬¡æ€§èµ·è‰çš„å•è¯æ•°é‡ (ä¾‹å¦‚ 4 ä¸ª)ã€‚**ç­–ç•¥**: å¼ºè°ƒè¿™å†³å®šäº†â€œèµŒæ³¨â€çš„å¤§å°ã€‚ |
| **Memory Wall (Memory Bound)** | **é˜…è¯»é€Ÿåº¦ç“¶é¢ˆ** | ä¸»ç¼–çš„å¤§è„‘è¿è½¬æå¿« (è®¡ç®—å¿«)ï¼Œä½†ç¿»ä¹¦é€Ÿåº¦å¤ªæ…¢ (æ˜¾å­˜å¸¦å®½é™åˆ¶)ã€‚ä»–è¯»å®Œä¸€éä¹¦åªèƒ½å†™ä¸€ä¸ªå­—å¤ªäºäº†ï¼Œä¸å¦‚è¯»ä¸€éä¹¦æ‰¹æ”¹ 5 ä¸ªå­—ã€‚ |
| **KV Cache** | **å¯¹è¯è®°å¿†æœ¬ (Context Notebook)** | **å…³é”®çº é”™ç‚¹**: å¿…é¡»å¼ºè°ƒè¿™æ˜¯ä¸€ä¸ª**ç‰©ç†ç¬”è®°æœ¬**ã€‚å¦‚æœå®ä¹ ç”Ÿå†™é”™äº† (Rejected)ï¼Œå¿…é¡»ç”¨æ©¡çš®æ“¦**ç‰©ç†æ“¦é™¤** (Rollback/Truncate) é”™è¯¯å†…å®¹ï¼Œç»å¯¹ä¸èƒ½ç•™ç€è¯¯å¯¼åç»­å¯¹è¯ã€‚ |
| **Acceptance Rate ($\alpha$)** | **é€šè¿‡ç‡** | ä¸»ç¼–é‡‡çº³å®ä¹ ç”Ÿè‰ç¨¿çš„æ¯”ä¾‹ã€‚è¿™ç›´æ¥å†³å®šäº†æˆ‘ä»¬æ˜¯â€œèµšäº†â€è¿˜æ˜¯â€œèµ”äº†â€ã€‚ |

---

## 2. Technical Deep Dive: The "Why" & "How" (æŠ€æœ¯æ·±åº¦è§£æ)

### 2.1 Why it works? (åŸç†è§£æ„)
å¤§è¯­è¨€æ¨¡å‹çš„ç”Ÿæˆè¿‡ç¨‹ç¬¦åˆ**è¯­è¨€çš„â€œäºŒå…«å®šå¾‹â€**ã€‚
*   **Easy Tokens (60-80%)**: è™šè¯ã€å›ºå®šæ­é…ã€å¸¸è§çŸ­è¯­ï¼ˆå¦‚ `of`, `the`, `San Francisco`ï¼‰ã€‚è¿™äº›è¯ä¸éœ€è¦æ·±å±‚é€»è¾‘ï¼Œæµ…å±‚ç»Ÿè®¡å³å¯é¢„æµ‹ã€‚
*   **Hard Tokens (20-40%)**: é€»è¾‘è½¬æŠ˜ã€çŸ¥è¯†æ£€ç´¢ã€åˆ›æ„ç”Ÿè¯ã€‚è¿™äº›æ‰çœŸæ­£éœ€è¦å¤§æ¨¡å‹çš„â€œæ·±æ€ç†Ÿè™‘â€ã€‚

### 2.2 Draft Model Profiling (å°æ¨¡å‹ç”»åƒ)
*   **æåº¦è½»é‡ (Ultra-Lightweight)**: å‚æ•°é‡é€šå¸¸ä»…ä¸º Target Model çš„ **1/100** (e.g., 60M vs 7B)ã€‚è¿™ä½¿å¾—å®ƒçš„è¿è¡Œæ—¶é—´ ($T_{draft}$) ç›¸å¯¹äºå¤§æ¨¡å‹ ($T_{target}$) å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚
*   **åŒæºåä½œ (Shared Tokenizer)**: å¿…é¡»ä½¿ç”¨ä¸ Target Model å®Œå…¨ç›¸åŒçš„è¯è¡¨ã€‚å°±åƒå®ä¹ ç”Ÿå’Œä¸»ç¼–å¿…é¡»ä½¿ç”¨åŒä¸€ç§è¯­è¨€äº¤æµï¼Œå¦åˆ™æ— æ³•åä½œã€‚
*   **å±€éƒ¨ä¸“å®¶ (Local Expert)**: æ“…é•¿çŸ­è·ç¦»çš„ç»Ÿè®¡é¢„æµ‹ï¼Œä½†ç¼ºä¹é•¿è·ç¦»çš„é€»è¾‘æ¨ç†èƒ½åŠ›ã€‚

### 2.3 Scenarios Analysis (å…¸å‹åœºæ™¯åˆ†æ)
| åœºæ™¯ç±»å‹ | å‘½ä¸­ç‡ ($\alpha$) | åŸå› åˆ†æ | å…¸å‹ä¾‹å­ |
| :--- | :--- | :--- | :--- |
| **High Confidence** | **é«˜ (>80%)** | ç»“æ„å›ºå®šï¼Œå†—ä½™åº¦é«˜ | ä»£ç è¡¥å…¨ (`for i in range`), å¸¸ç”¨è¯­ (`Thank you very much`) |
| **Low Confidence** | **ä½ (<30%)** | é€»è¾‘è·³è·ƒï¼ŒçŸ¥è¯†å¯†é›† | åˆ›æ„å†™ä½œè½¬æŠ˜ (`However...`), äº‹å®é—®ç­” (`Q: Who is...`), æ•°å­¦è®¡ç®— |

### 2.5 Resource Saving Mechanism (èµ„æºèŠ‚çœçš„ç‰©ç†çœŸç›¸)
**æ ¸å¿ƒé—®é¢˜**: å¦‚æœå®ä¹ ç”ŸçŒœå¯¹äº†ï¼Œä¸»ç¼–ä¸ºä»€ä¹ˆèƒ½çœåŠ›ï¼Ÿ
*   **è¯¯åŒº**: ä¸»ç¼–â€œä¸ç”¨æ€è€ƒäº†â€ã€‚
*   **çœŸç›¸**: ä¸»ç¼–ä¾ç„¶è¦æ€è€ƒï¼ˆè®¡ç®—é‡æ²¡å°‘ï¼‰ï¼Œä½†**çœå»äº†æ¬ä¹¦çš„åŠ›æ°”**ï¼ˆæ˜¾å­˜å¸¦å®½ï¼‰ã€‚
    *   **Serial Mode (ä¼ ç»Ÿ)**: æ¬è¿ 26GB æƒé‡ -> ç®— 1 ä¸ªè¯ã€‚ (æ¬è¿ 4 æ¬¡ï¼Œç®— 4 ä¸ªè¯)
    *   **Speculative Mode (æŠ•æœº)**: æ¬è¿ 26GB æƒé‡ -> **åŒæ—¶**ç®— 4 ä¸ªè¯ã€‚ (æ¬è¿ 1 æ¬¡ï¼Œç®— 4 ä¸ªè¯)
    *   **ç»“è®º**: èŠ‚çœçš„æ˜¯æ˜‚è´µçš„ **HBM æ˜¾å­˜å¸¦å®½ (Memory Bandwidth)**ï¼Œè€Œéè®¡ç®— (Compute)ã€‚

### 2.6 Cost of Failure (å¤±è´¥çš„ä»£ä»·ä¸æ“¦é™¤å¯¹è±¡)
**æ ¸å¿ƒé—®é¢˜**: é¢„æµ‹å¤±è´¥äº†ï¼Œè¦æ“¦æ‰è°çš„èµ„æºï¼Ÿ
*   **å¯¹è±¡**: **Target Model (ä¸»ç¼–) çš„ KV Cache**ã€‚
*   **è¿‡ç¨‹**:
    1.  ä¸»ç¼–åœ¨éªŒè¯æ—¶ï¼Œå…¶å®å·²ç»æŠŠå®ä¹ ç”ŸçŒœçš„ `["12:00", "exactly"]` å½“ä½œå‡è®¾äº‹å®ï¼Œç”Ÿæˆäº†å¯¹åº”çš„ KV Cacheã€‚
    2.  å½“ä¸»ç¼–å‘ç° `12:00` é”™æ—¶ï¼Œåç»­åŸºäº `12:00` ç”Ÿæˆçš„ `exactly` çš„ KV Cache å…¨éƒ¨å˜ä¸º**è„æ•°æ®**ã€‚
    3.  **Action**: å¿…é¡»ç‰©ç†æ“¦é™¤ (Reset Pointer) è¿™éƒ¨åˆ†è„æ˜¾å­˜ï¼Œå¦åˆ™ä¼šæ±¡æŸ“åç»­å¯¹è¯ã€‚
    4.  **ä»£ä»·**: ä»…ä»…æ˜¯é‡ç½®æŒ‡é’ˆçš„å¾®å°å¼€é”€ï¼Œä»¥åŠæµªè´¹äº†åˆšæ‰é‚£ä¸€æ¬¡â€œå¹¶è¡Œè®¡ç®—â€çš„ç”µè´¹ã€‚

---

## 3. Concrete, Diverse Data Snapshots (å…·è±¡åŒ–æ•°æ®å¿«ç…§)

ä¸ºäº†éªŒè¯ç®—æ³•åœ¨ä¸åŒåœºæ™¯ä¸‹çš„è¡¨ç°ï¼Œæˆ‘ä»¬é€‰å–ä¸¤ç»„å…·æœ‰æ˜¾è‘—**ç†µ (Entropy)** å·®å¼‚çš„æ•°æ®ã€‚

### Data A: The "High-Confidence" Scenario (é«˜ç¡®å®šæ€§/ä»£ç è¡¥å…¨)
*   **åœºæ™¯**: Python ä»£ç è¡¥å…¨ã€‚ç»“æ„å›ºå®šï¼Œè¯­æ³•ä¸¥è°¨ï¼Œé¢„æµ‹éš¾åº¦ä½ã€‚
*   **ç‰¹ç‚¹**: **é«˜é€šè¿‡ç‡ ($\alpha \approx 0.9$)**ã€‚
*   **Content**:
    ```python
    def calculate_area(radius):
        # User typed above, model generates below
        import math
        return math.pi * radius ** 2
    ```
*   **Tokens (Ground Truth)**: `["import", " math", "\n", "   ", " return", " math", ".", "pi", " *", " radius"]`

### Data B: The "High-Entropy" Scenario (é«˜ä¸ç¡®å®šæ€§/åˆ›æ„å†™ä½œ)
*   **åœºæ™¯**: å°è¯´ç»­å†™ã€‚æªè¾çµæ´»ï¼Œå¯èƒ½æ€§å¤šï¼Œé¢„æµ‹éš¾åº¦é«˜ã€‚
*   **ç‰¹ç‚¹**: **ä¸­ä½é€šè¿‡ç‡ ($\alpha \approx 0.4$)**ã€‚
*   **Content**:
    *   *Prompt*: "The detective stared at the broken clock. It was stuck at..."
    *   *Target Generation*: "...midnight, a silent witness to the crime."
    *   *Draft Prediction*: "...12:00, exactly when the murder happened."
*   **Conflict**: Draft (å®ä¹ ç”Ÿ) çŒœçš„æ˜¯ "12:00"ï¼ŒTarget (ä¸»ç¼–) æƒ³å†™ "midnight"ã€‚è¿™é‡Œå°†å‘ç”Ÿ **Rejection & Correction**ã€‚

---

## 3. The Value Scenario: Quantitative Comparison (æ ¸å¿ƒä»·å€¼åœºæ™¯ï¼šå®šé‡å¯¹æ¯”)

### 3.1 åœºæ™¯å®šä¹‰
*   **ç¡¬ä»¶**: å•å¡ **NVIDIA A100 (40GB HBM2e)**
    *   *Bandwidth (BW)*: ~1,555 GB/s
*   **æ¨¡å‹é…ç½®**:
    *   **Target (ä¸»ç¼–)**: LLaMA-2-13B (FP16)
        *   *Size ($M_T$)*: ~26 GB
    *   **Draft (å®ä¹ ç”Ÿ)**: LLaMA-68M (FP16)
        *   *Size ($M_D$)*: ~0.14 GB (ä»…ä¸ºä¸»æ¨¡å‹çš„ 0.5%)
*   **ä»»åŠ¡**: ç”Ÿæˆ 100 ä¸ª Tokenã€‚
*   **æŠ•æœºçª—å£ ($K$)**: 4 (å®ä¹ ç”Ÿæ¯æ¬¡çŒœ 4 ä¸ªè¯)ã€‚

### 3.2 Baseline åˆ†æ (ä¼ ç»Ÿè‡ªå›å½’ Autoregressive)
ä¼ ç»Ÿæ¨¡å¼ä¸‹ï¼Œç”Ÿæˆ 1 ä¸ª Token éœ€è¦å°† 26GB æƒé‡å®Œæ•´æ¬è¿ä¸€æ¬¡ã€‚

*   **è®¡ç®—**:
    *   **Memory Access Time ($T_{mem}$)**: $\frac{26 \text{ GB}}{1,555 \text{ GB/s}} \approx 16.7 \text{ ms}$
    *   **Compute Time ($T_{comp}$)**: çº¦ä¸º 3ms (å¯¹äº Batch=1, Memory dominate)ã€‚
    *   **Total Latency per Token**: $16.7 + 3 \approx \mathbf{20 \text{ ms}}$
*   **æ€»è€—æ—¶ (100 Tokens)**:
    *   $100 \times 20 \text{ ms} = \mathbf{2,000 \text{ ms} (2.0s)}$

### 3.3 Target Solution åˆ†æ (Speculative Decoding $K=4$)
æˆ‘ä»¬å‡è®¾åœ¨ **Data A (ä»£ç è¡¥å…¨)** åœºæ™¯ä¸‹ï¼Œå¹³å‡é€šè¿‡ç‡ $\alpha = 0.8$ã€‚

*   **Step 1: Draft Generation (å®ä¹ ç”Ÿå·¥ä½œ)**
    *   å®ä¹ ç”Ÿè·‘ 4 æ¬¡ (ä¸²è¡Œ)ã€‚
    *   $T_{draft} \approx 4 \times (\frac{0.14 \text{ GB}}{1,555 \text{ GB/s}} + 0.5 \text{ ms}) \approx 4 \times 0.6 \text{ ms} = \mathbf{2.4 \text{ ms}}$
    *   *æ³¨: å°æ¨¡å‹æå¿«ï¼Œå‡ ä¹å¿½ç•¥ä¸è®¡ã€‚*

*   **Step 2: Target Verification (ä¸»ç¼–å·¥ä½œ)**
    *   ä¸»ç¼–éªŒè¯ 5 ä¸ª Token (4ä¸ªçŒœæµ‹ + 1ä¸ªæœ€åç¡®è®¤)ã€‚
    *   ç”±äºæ˜¯å¹¶è¡Œè®¡ç®— (Parallel Forward Pass)ï¼Œè¯»å–æƒé‡çš„å¼€é”€ä¸å˜ï¼Œè®¡ç®—é‡å¾®å¢ã€‚
    *   $T_{verify} \approx 16.7 \text{ ms (Mem)} + 4 \text{ ms (Comp)} = \mathbf{20.7 \text{ ms}}$

*   **Step 3: Expected Output (æœŸæœ›äº§å‡º)**
    *   åŸºäº $\alpha=0.8$ï¼Œå¹³å‡æ¯æ¬¡è¿­ä»£äº§å‡ºçš„æœ‰æ•ˆ Token æ•° $E = \frac{1-\alpha^{K+1}}{1-\alpha} \approx 3.3$ ä¸ªã€‚
    *   *é€šä¿—è§£é‡Š*: èŠ±è´¹ä¸€æ¬¡éªŒè¯çš„æ—¶é—´ï¼Œæˆ‘ä»¬å¹³å‡â€œèµšåˆ°â€äº† 3.3 ä¸ªè¯ã€‚

*   **Total Latency per Step**:
    *   $2.4 \text{ ms (Draft)} + 20.7 \text{ ms (Verify)} = \mathbf{23.1 \text{ ms}}$

*   **Effective Latency per Token**:
    *   $\frac{23.1 \text{ ms}}{3.3 \text{ tokens}} \approx \mathbf{7.0 \text{ ms/token}}$

### 3.4 Computational Formula (æ ¸å¿ƒè®¡ç®—å…¬å¼)

ä¸ºäº†æ•°å­¦åŒ–åœ°è¯æ˜æŠ•æœºè§£ç çš„æ”¶ç›Šï¼Œæˆ‘ä»¬å®šä¹‰ä»¥ä¸‹å˜é‡ï¼š

*   $T_{draft}$: å®ä¹ ç”Ÿç”Ÿæˆ 1 ä¸ª Token çš„è€—æ—¶ (æå°)ã€‚
*   $T_{target}$: ä¸»ç¼–ç”Ÿæˆ 1 ä¸ª Token çš„è€—æ—¶ (æå¤§ï¼Œä¸»è¦ç”±æ˜¾å­˜æ¬è¿ $M_{target}$ å†³å®š)ã€‚
*   $K$: æŠ•æœºçª—å£å¤§å° (æ¯æ¬¡çŒœ K ä¸ª)ã€‚
*   $\alpha$: æ¥å—ç‡ (Acceptance Rate)ã€‚
*   $N$: æ€»å…±éœ€è¦ç”Ÿæˆçš„ Token æ•°é‡ã€‚

#### 1. ä¼ ç»Ÿè‡ªå›å½’æ¨¡å¼ (Baseline)
æ¯æ¬¡ç”Ÿæˆéƒ½å¿…é¡»ä¸²è¡Œè¿è¡Œä¸»ç¼–æ¨¡å‹ã€‚
$$
\text{Latency}_{\text{base}} = N \times T_{target}
$$

#### 2. æŠ•æœºè§£ç æ¨¡å¼ (Speculative)
æ¯ä¸ª Step åˆ†ä¸ºä¸¤æ­¥ï¼š
1.  **Drafting (ä¸²è¡Œ)**: å®ä¹ ç”Ÿç”Ÿæˆ K ä¸ªè¯ã€‚è€—æ—¶ $K \times T_{draft}$ã€‚
2.  **Verification (å¹¶è¡Œ)**: ä¸»ç¼–ä¸€æ¬¡æ€§éªŒè¯ K+1 ä¸ªè¯ã€‚è€—æ—¶ $\approx T_{target}$ (å› ä¸ºå¹¶è¡Œè®¡ç®—ï¼Œè€—æ—¶ä¸ç”Ÿæˆ 1 ä¸ªè¯å‡ ä¹ç›¸åŒï¼Œåªå¢åŠ äº†å¾®å°çš„è®¡ç®—é‡ï¼Œæ˜¾å­˜æ¬è¿æ—¶é—´ä¸å˜)ã€‚

æ¯ä¸ª Step çš„æ€»è€—æ—¶ï¼š
$$
\text{Time}_{\text{step}} = K \times T_{draft} + T_{target}
$$

æ¯ä¸ª Step å¹³å‡äº§å‡ºçš„æœ‰æ•ˆ Token æ•° (Expectation)ï¼š
$$
E_{\text{tokens}} = \frac{1 - \alpha^{K+1}}{1 - \alpha} \quad (\text{å½“ } \alpha < 1)
$$
*(æ³¨: å¦‚æœ $\alpha=1$ å…¨éƒ¨æ¥å—ï¼Œåˆ™ $E = K+1$)*

#### 3. åŠ é€Ÿæ¯” (Speedup Ratio)
$$
\text{Speedup} = \frac{\text{Latency}_{\text{base}}}{\text{Latency}_{\text{spec}}} = \frac{T_{target} \times E_{\text{tokens}}}{\text{Time}_{\text{step}}} = \frac{T_{target} \times E_{\text{tokens}}}{K \times T_{draft} + T_{target}}
$$

**ä»£å…¥å…¸å‹æ•°å€¼è®¡ç®— (A100 ç¯å¢ƒ):**
*   $T_{target} \approx 20 \text{ ms}$ (26GB / 1.5TB/s)
*   $T_{draft} \approx 0.6 \text{ ms}$ (0.14GB / 1.5TB/s)
*   $K = 4$
*   $\alpha = 0.8$ (Code Generation)

1.  **æœ‰æ•ˆäº§å‡º $E$**: $\frac{1 - 0.8^5}{1 - 0.8} \approx 3.36$ ä¸ª Tokenã€‚
2.  **Step è€—æ—¶**: $4 \times 0.6 + 20 = 22.4 \text{ ms}$ã€‚
3.  **å• Token è€—æ—¶**: $22.4 / 3.36 \approx 6.67 \text{ ms}$ã€‚
4.  **åŠ é€Ÿæ¯”**: $20 / 6.67 \approx \mathbf{3.0x}$ã€‚

---

### 3.5 Value Delta (ä»·å€¼å¢é‡æ€»ç»“)

| Metric | Baseline (ä¼ ç»Ÿ) | Target (æŠ•æœºè§£ç ) | Delta (æå‡) |
| :--- | :--- | :--- | :--- |
| **å• Token å»¶è¿Ÿ** | 20 ms | 7.0 ms | **é€Ÿåº¦æå‡ 2.85x** ğŸš€ |
| **æ˜¾å­˜å¸¦å®½åˆ©ç”¨ç‡** | ä½ (å¤§é‡é—²ç½®ç­‰å¾…) | é«˜ (ä¸€æ¬¡æ¬è¿åšæ›´å¤šäº‹) | **æ•ˆèƒ½æ›´ä¼˜** |
| **æ˜¾å­˜å ç”¨** | ~26 GB | ~26.2 GB (ä»…å¢åŠ å¾®é‡ Draft æƒé‡) | **å‡ ä¹æ— ç—›** |

> **å…³é”®ç»“è®º**: ç›¸æ¯”ä¼ ç»Ÿæ–¹æ¡ˆï¼Œæˆ‘ä»¬åœ¨æ˜¾å­˜å ç”¨å‡ ä¹ä¸å˜ (<1% å¢åŠ ) çš„æƒ…å†µä¸‹ï¼Œå°†æ¨ç†é€Ÿåº¦æå‡äº† **è¿‘ 3 å€**ã€‚è¿™å°±æ˜¯æ‰“ç ´â€œå†…å­˜å¢™â€çš„é­”åŠ›ã€‚

### 3.6 Verification Logic: The Probability Game (éªŒè¯é€»è¾‘ï¼šæ¦‚ç‡åšå¼ˆ)

ä¸»ç¼–å¦‚ä½•åˆ¤å®šå®ä¹ ç”Ÿçš„è‰ç¨¿æ˜¯å¦åˆæ ¼ï¼Ÿè¿™å¹¶éç®€å•çš„â€œå¯¹ç­”æ¡ˆ (String Matching)â€ï¼Œè€Œæ˜¯åŸºäºä¸¥æ ¼çš„**æ‹’ç»é‡‡æ · (Rejection Sampling)** æœºåˆ¶ï¼Œä»¥ç¡®ä¿æ•°å­¦ä¸Šçš„**æ— æŸæ€§ (Lossless Property)**ã€‚

#### 1. æ ¸å¿ƒåŸåˆ™
æŠ•æœºè§£ç å¿…é¡»ä¿è¯ï¼š**æœ€ç»ˆè¾“å‡ºçš„ Token åˆ†å¸ƒï¼Œå¿…é¡»ä¸ Target Model å•ç‹¬ç”Ÿæˆçš„åˆ†å¸ƒå®Œå…¨ä¸€è‡´ã€‚**
ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸èƒ½å› ä¸ºç”¨äº†å®ä¹ ç”Ÿï¼Œå°±å¯¼è‡´ç”Ÿæˆçš„æ–‡æœ¬è´¨é‡ä¸‹é™æˆ–é£æ ¼è·‘åã€‚

#### 2. åˆ¤å®šç®—æ³•
å‡è®¾å¯¹äºä½ç½® $i$ï¼Œå®ä¹ ç”Ÿé¢„æµ‹ Token $x$ çš„æ¦‚ç‡ä¸º $q(x)$ï¼Œä¸»ç¼–è®¡ç®—è¯¥ Token çš„æ¦‚ç‡ä¸º $p(x)$ã€‚

*   **Case A: å®ä¹ ç”Ÿæ¯”è¾ƒä¿å®ˆ (Accept)**
    *   **æ¡ä»¶**: $p(x) \ge q(x)$
    *   **è§£é‡Š**: ä¸»ç¼–è®¤ä¸º Token $x$ çš„æ¦‚ç‡ (e.g. 80%) æ¯”å®ä¹ ç”Ÿé¢„æµ‹çš„ (e.g. 60%) è¿˜è¦é«˜ã€‚
    *   **åŠ¨ä½œ**: **ç›´æ¥æ¥å—**ã€‚
    *   **ä¿®æ­£é¡¹**: å‰©ä½™çš„æ¦‚ç‡å·® $p(x) - q(x)$ ä¼šè¢«ä¿ç•™ï¼Œç”¨äºåç»­å½’ä¸€åŒ–ï¼Œç¡®ä¿åˆ†å¸ƒå¹³è¡¡ã€‚

*   **Case B: å®ä¹ ç”Ÿè¿‡åº¦è‡ªä¿¡ (Probabilistic Reject)**
    *   **æ¡ä»¶**: $p(x) < q(x)$
    *   **è§£é‡Š**: å®ä¹ ç”Ÿè®¤ä¸ºè‚¯å®šæ˜¯ $x$ (e.g. 99%)ï¼Œä½†ä¸»ç¼–è§‰å¾— $x$ åªæœ‰ 40% çš„å¯èƒ½ã€‚
    *   **åŠ¨ä½œ**: **ä»¥æ¦‚ç‡ $1 - \frac{p(x)}{q(x)}$ æ‹’ç»**ã€‚
    *   **ç›´è§‰**: å¹¶ä¸æ˜¯ç›´æ¥ä¸€æ£’å­æ‰“æ­»ï¼Œè€Œæ˜¯æ·éª°å­ã€‚å¦‚æœ $p(x)$ å’Œ $q(x)$ å·®å¼‚ä¸å¤§ï¼Œä»æœ‰æœºä¼šé€šè¿‡ï¼›å·®å¼‚è¶Šå¤§ï¼Œæ‹’ç»æ¦‚ç‡è¶Šé«˜ã€‚

#### 3. æ‹’ç»åçš„ä¿®æ­£ (Resample)
ä¸€æ—¦æ‹’ç»å‘ç”Ÿï¼Œä¸»ç¼–å¿…é¡»**æ¥ç®¡**åç»­å·¥ä½œã€‚
*   ä¸»ç¼–ä¼šæ ¹æ®ä¿®æ­£åçš„æ¦‚ç‡åˆ†å¸ƒ $p'(x) = \text{norm}(\max(0, p(x) - q(x)))$ é‡æ–°é‡‡æ ·ä¸€ä¸ªæ–°çš„ Tokenã€‚
*   è¿™ç¡®ä¿äº†å³ä½¿å‘ç”Ÿäº†æ‹’ç»ï¼Œæœ€ç»ˆé€‰å‡ºçš„è¯ä¾ç„¶ä¸¥æ ¼éµå¾ªä¸»ç¼–çš„æ„æ„¿ã€‚

> **ç»“è®º**: è¿™ç§æœºåˆ¶è®©æŠ•æœºè§£ç æˆä¸ºäº†ä¸€ä¸ª**â€œæ— æŸåŠ é€Ÿå™¨â€**â€”â€”é€Ÿåº¦æ˜¯å®ä¹ ç”Ÿçš„ï¼Œè´¨é‡æ˜¯ä¸»ç¼–çš„ã€‚

---

## 4. Core Concepts & Visual Ontology (æ ¸å¿ƒæ¦‚å¿µä¸è§†è§‰æœ¬ä½“)

ä¸ºäº†æ”¯æŒè§†é¢‘è„šæœ¬ï¼Œæˆ‘ä»¬å®šä¹‰ä»¥ä¸‹å¯è§†åŒ–å®ä½“ï¼š

*   **Entity 1: The Weight Matricies (æƒé‡çŸ©é˜µå—)**
    *   *Visual*: å·¨å¤§çš„åŠé€æ˜ç«‹æ–¹ä½“ã€‚
    *   *Draft*: å°å¦‚ç«æŸ´ç›’ (è“è‰²)ã€‚
    *   *Target*: å¤§å¦‚é›†è£…ç®± (ç´«è‰²)ã€‚
    *   *Action*: æ¯æ¬¡æ¨ç†æ—¶ï¼Œå¿…é¡»ä»å·¦ä¾§ (æ˜¾å­˜) æ¬è¿åˆ°å³ä¾§ (è®¡ç®—å•å…ƒ)ã€‚

*   **Entity 2: The Token Stream (Token ä¼ é€å¸¦)**
    *   *Visual*: ç±»ä¼¼å·¥å‚æµæ°´çº¿ã€‚
    *   *State*:
        *   **Solid (å®å¿ƒ)**: å·²ç¡®è®¤çš„ Token (Context)ã€‚
        *   **Ghost (è™šå½±)**: å®ä¹ ç”ŸçŒœæµ‹çš„ Token (Draft Tokens)ã€‚
        *   **Green Check**: éªŒè¯é€šè¿‡ã€‚
        *   **Red Cross**: éªŒè¯å¤±è´¥ (è§¦å‘å›æ»šåŠ¨ç”»)ã€‚

*   **Entity 3: The KV Cache (è®°å¿†æ—¶é—´è½´)**
    *   *Visual*: ä½äºå±å¹•ä¸‹æ–¹çš„è¿›åº¦æ¡/æ ¼æ§½ã€‚
    *   *Critical Animation*: å½“çº¢è‰²å‰å·å‡ºç°æ—¶ï¼Œå¿…é¡»å±•ç¤ºä¸€ä¸ª **"Rewind/Erase" (å€’å¸¦/æ“¦é™¤)** çš„ç‰¹æ•ˆï¼Œå°†åé¢å‡ ä¸ªæ ¼æ§½é‡Œçš„æ•°æ®æ¸…ç©ºã€‚**è¿™æ˜¯ä¸ºäº†çº æ­£ç”¨æˆ·å…³äºâ€œä¿ç•™è´Ÿæ ·æœ¬â€çš„è¯¯åŒºã€‚**

---

## 5. End-to-End Interaction Pipeline (å…¨é“¾è·¯äº¤äº’ç®¡çº¿)

æˆ‘ä»¬æ¼”ç¤ºå¤„ç† **Data B (åˆ›æ„å†™ä½œ)** çš„ä¸€ä¸ªå®Œæ•´å‘¨æœŸï¼Œå±•ç¤ºâ€œå¤±è´¥ä¸å›æ»šâ€çš„çœŸå®å·¥ç¨‹é“¾è·¯ã€‚

1.  **Context Loading**:
    *   è¾“å…¥: "The detective stared at..."
    *   KV Cache åˆå§‹åŒ–ã€‚

2.  **Drafting (The Intern's Guess)**:
    *   Draft Model å¿«é€Ÿè¿è¡Œ 3 æ¬¡ã€‚
    *   ç”Ÿæˆè™šå½± Tokens: `["the", " broken", " watch"]`ã€‚
    *   *Visual*: è“è‰²å°äººé£å¿«åœ°åœ¨ä¼ é€å¸¦ä¸Šæ”¾äº†ä¸‰ä¸ªåŠé€æ˜ç›’å­ã€‚

3.  **Verification (The Boss's Check)**:
    *   Target Model è¯»å–ä¸€æ¬¡æƒé‡ (å·¨å¤§çš„ç´«è‰²é›†è£…ç®±ç§»åŠ¨)ã€‚
    *   å¹¶è¡Œè®¡ç®—ï¼šåŒæ—¶è®¡ç®— `["the", " broken", " watch"]` åœ¨ä¸»ç¼–çœ¼é‡Œçš„æ¦‚ç‡ã€‚

4.  **Comparison & Rollback (The Engineering Reality)**:
    *   **Token 1 ("the")**: ä¸»ç¼–æ¦‚ç‡ 99%ï¼Œå®ä¹ ç”Ÿæ¦‚ç‡ 90%ã€‚**Accept** âœ…ã€‚
    *   **Token 2 (" broken")**: ä¸»ç¼–æ¦‚ç‡ 95%ï¼Œå®ä¹ ç”Ÿæ¦‚ç‡ 85%ã€‚**Accept** âœ…ã€‚
    *   **Token 3 (" watch")**: ä¸»ç¼–æ¦‚ç‡ 0.1% (ä¸»ç¼–è®¤ä¸ºåº”è¯¥æ˜¯ " clock")ã€‚**Reject** âŒã€‚
    *   **Action**:
        *   ä¸¢å¼ƒ " watch"ã€‚
        *   **KV Cache Truncate**: å¿…é¡»æŠŠç”Ÿæˆ " watch" äº§ç”Ÿçš„é‚£éƒ¨åˆ† KV Cache åˆ æ‰ï¼
        *   **Resample**: ä¸»ç¼–æ ¹æ®å‰©ä½™æ¦‚ç‡ï¼Œç›´æ¥é‡‡æ ·å‡º " clock"ã€‚

5.  **Commit**:
    *   å°† `["the", " broken", " clock"]` å˜ä¸ºå®å¿ƒï¼ŒåŠ å…¥ Contextã€‚
    *   è™½ç„¶çŒœé”™äº†ç¬¬ 3 ä¸ªï¼Œä½†æˆ‘ä»¬ä¾ç„¶åœ¨ä¸€ä¸ªå‘¨æœŸå†…ç”Ÿæˆäº† 3 ä¸ªè¯ (2ä¸ªçŒœå¯¹ + 1ä¸ªä¿®æ­£)ã€‚ä¾ç„¶æ¯”ä¼ ç»Ÿæ¨¡å¼å¿«ï¼
